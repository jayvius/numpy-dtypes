

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating New Generalized UFunc for Custom DType &mdash; UFuncs and Custom DTypes 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="UFuncs and Custom DTypes 1.0 documentation" href="index.html" />
    <link rel="prev" title="Creating New UFunc for Custom DType" href="newufunc.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="newufunc.html" title="Creating New UFunc for Custom DType"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">UFuncs and Custom DTypes 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="creating-new-generalized-ufunc-for-custom-dtype">
<h1>Creating New Generalized UFunc for Custom DType<a class="headerlink" href="#creating-new-generalized-ufunc-for-custom-dtype" title="Permalink to this headline">Â¶</a></h1>
<p>The next example shows how to create a new generalized ufunc for the Rational dtype.
The gufunc example creates a gufunc &#8216;matrix_multiply&#8217; which loops over a pair of
vectors or matrices and performs a matrix multiply on each pair of matrix elements.</p>
<ol class="arabic">
<li><p class="first">A loop function is created to loop through the outer or loop dimensions, performing a
matrix multiply operation on the core dimensions for each loop:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">rational_gufunc_matrix_multiply</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="n">npy_intp</span> <span class="o">*</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">npy_intp</span> <span class="o">*</span><span class="n">steps</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">NPY_UNUSED</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// outer dimensions counter</span>
    <span class="n">npy_intp</span> <span class="n">N_</span><span class="p">;</span>

    <span class="c1">// length of flattened outer dimensions</span>
    <span class="n">npy_intp</span> <span class="n">dN</span> <span class="o">=</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="c1">// striding over flattened outer dimensions for input and output arrays</span>
    <span class="n">npy_intp</span> <span class="n">s0</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">// loop through outer dimensions, performing matrix multiply on core dimensions for each loop</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">N_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">N_</span> <span class="o">&lt;</span> <span class="n">dN</span><span class="p">;</span> <span class="n">N_</span><span class="o">++</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s0</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s1</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rational_matrix_multiply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the input matrices have more than one outer dimension, the outer dimensions are flattened from the
perspective of the loop function.</p>
<p>The matrix multiply function:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="n">NPY_INLINE</span> <span class="kt">void</span>
<span class="nf">rational_matrix_multiply</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="n">npy_intp</span> <span class="o">*</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">npy_intp</span> <span class="o">*</span><span class="n">steps</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// pointers to data for input and output arrays</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ip1</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ip2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">// lengths of core dimensions</span>
    <span class="n">npy_intp</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">dp</span> <span class="o">=</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">// striding over core dimensions</span>
    <span class="n">npy_intp</span> <span class="n">is1_m</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">is1_n</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">is2_n</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">is2_p</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">os_m</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">npy_intp</span> <span class="n">os_p</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="c1">// core dimensions counters</span>
    <span class="n">npy_intp</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>

    <span class="c1">// calculate dot product for each row/column vector pair</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">dm</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">dp</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">npyrational_dot</span><span class="p">(</span><span class="n">ip1</span><span class="p">,</span> <span class="n">is1_n</span><span class="p">,</span> <span class="n">ip2</span><span class="p">,</span> <span class="n">is2_n</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="n">ip2</span> <span class="o">+=</span> <span class="n">is2_p</span><span class="p">;</span>
            <span class="n">op</span>  <span class="o">+=</span>  <span class="n">os_p</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ip2</span> <span class="o">-=</span> <span class="n">is2_p</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
        <span class="n">op</span> <span class="o">-=</span> <span class="n">os_p</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>

        <span class="n">ip1</span> <span class="o">+=</span> <span class="n">is1_m</span><span class="p">;</span>
        <span class="n">op</span> <span class="o">+=</span> <span class="n">os_m</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</li>
<li><p class="first">In the &#8216;initrational&#8217; function used to initialize the Rational dtype with numpy,
a new PyUFuncObject is created for the new &#8216;matrix_multiply&#8217; generalized ufunc using the
PyUFunc_FromFuncAndDataAndSignature function:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PyObject</span><span class="o">*</span> <span class="n">gufunc</span> <span class="o">=</span> <span class="n">PyUFunc_FromFuncAndDataAndSignature</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">PyUFunc_None</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;matrix_multiply&quot;</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;return result of multiplying two matrices of rationals&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;(m,n),(n,p)-&gt;(m,p)&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This is identical to the PyUFunc_FromFuncAndData function used to create a ufunc object in the examples above,
with the addition of a ufunc signature describing the core dimensions of the input and output arrays. In this
example, the generalized ufunc operates on pairs of matrices with dimensions (m,n) and (n,p), producing an
output matrix of dimensions (m,p).</p>
</li>
<li><p class="first">The loop function is registered using the loop function and the PyUFuncObject created in step 2:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="n">types2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">npy_rational</span><span class="p">,</span><span class="n">npy_rational</span><span class="p">,</span><span class="n">npy_rational</span><span class="p">};</span>
<span class="k">if</span> <span class="p">(</span><span class="n">PyUFunc_RegisterLoopForType</span><span class="p">((</span><span class="n">PyUFuncObject</span><span class="o">*</span><span class="p">)</span><span class="n">gufunc</span><span class="p">,</span><span class="n">npy_rational</span><span class="p">,</span><span class="n">rational_gufunc_matrix_multiply</span><span class="p">,</span><span class="n">types2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Finally, a function called &#8216;matrix_multiply&#8217; is added to the rational module which
will call the numerator ufunc:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="s">&quot;matrix_multiply&quot;</span><span class="p">,(</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span><span class="n">gufunc</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="newufunc.html"
                        title="previous chapter">Creating New UFunc for Custom DType</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/newgufunc.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="newufunc.html" title="Creating New UFunc for Custom DType"
             >previous</a> |</li>
        <li><a href="index.html">UFuncs and Custom DTypes 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Jay Bourque.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>